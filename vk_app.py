import streamlit as st
import pandas as pd
import numpy as np
import re
import time
import requests
from collections import Counter
import plotly.express as px
from io import BytesIO

VK_THEME2SEGMENT = {
    "dj": "Музыка",
    "r&b": "Музыка",
    "rap, hip-hop": "Музыка",
    "авиакомпания": "Бизнес и финансы",
    "автовладельцы": "Авто и мото",
    "автомобили": "Авто, мото",
    "автомойка": "Авто и мото",
    "автопроизводитель": "Авто и мото",
    "автосалон": "Торговля и магазины",
    "автосервис": "Авто и мото",
    "автоспорт": "Спорт",
    "автотовары": "Авто и мото",
    "автошкола": "Авто и мото",
    "азартные игры": "Азартные игры",
    "активный отдых": "Путешествия и отдых",
    "актриса": "Кино",
    "актёр": "Кино",
    "актёр или актриса": "Кино",
    "альбом": "Музыка",
    "анимация": "Кино",
    "антиквариат": "Антиквариат",
    "аптека, оптика": "Медицина и здоровье",
    "аренда автомобилей": "Авто и мото",
    "астрология, эзотерика": "Астрология и эзотерика",
    "база отдыха": "Путешествия и отдых",
    "банк, финансовое учреждение": "Бизнес и финансы",
    "бар, паб": "Еда и напитки",
    "баскетбол": "Спорт",
    "баскетбольная команда": "Спорт",
    "бассейн": "Спорт",
    "безопасность": "Разное",
    "беременность, роды": "Семья, дети",
    "биатлонистка": "Спорт",
    "библиотека": "Книги",
    "бизнес": "Бизнес и предпринимательство",
    "благотворительная организация": "Благотворительность",
    "благотворительность": "Благотворительность",
    "блог": "Развлечения и медиа",
    "блогер": "Развлечения и медиа",
    "блюз": "Музыка",
    "боевые искусства": "Спорт",
    "больница": "Медицина и здоровье",
    "бутик": "Торговля и магазины",
    "бытовая техника": "IT и технологии",
    "веб-студия": "IT и технологии",
    "ведущая": "Развлечения и медиа",
    "ведущий": "Развлечения и медиа",
    "велосипеды": "Спорт",
    "ветеринарная клиника": "Медицина и здоровье",
    "видеоигра": "Видеоигры",
    "видеоигры": "Видеоигры",
    "вконтакте": "Соцсети",
    "водный спорт": "Спорт",
    "водный транспорт": "Спорт",
    "военное дело": "Милитаризм",
    "врач": "Медицина и здоровье",
    "вымышленный персонаж": "Развлечения и медиа",
    "высокие технологии": "IT и технологии",
    "галерея": "Культура, искусство",
    "гимназия": "Образование",
    "гипермаркет": "Торговля и магазины",
    "городское сообщество": "Общество",
    "гостиница": "Путешествия и отдых",
    "государственная организация": "Общество",
    "грузоперевозки": "Авто и мото",
    "группа выпускников": "Образование",
    "группа коллег": "Общение и знакомства",
    "группа памяти": "Общение и знакомства",
    "группа сокурсников": "Образование",
    "детская одежда и обувь": "Торговля и магазины",
    "детский сад": "Семья, дети",
    "детское питание": "Семья, дети",
    "джаз": "Музыка",
    "диеты, здоровое питание": "Медицина и здоровье",
    "дизайн и графика": "Дизайн",
    "дизайн интерьера": "Дизайн",
    "дизайн-студия": "Дизайн",
    "дизайнер": "Дизайн",
    "дискуссионный клуб": "Общество",
    "дом культуры": "Культура, искусство",
    "домашние и дикие животные": "Животные",
    "дополнительное образование": "Образование",
    "доставка еды": "Еда и напитки",
    "другая музыка": "Музыка",
    "другие виды спорта": "Спорт",
    "другие товары": "Торговля и магазины",
    "другие услуги": "Услуги",
    "другие хобби": "Хобби и развлечения",
    "друзья": "Разное",
    "духовное лицо": "Религия и духовность",
    "еда и напитки": "Еда и напитки",
    "журналист": "Журналистика",
    "журналист или журналистка": "Журналистика",
    "журналистка": "Журналистика",
    "закрытое сообщество": "Общество",
    "звукозапись": "Музыка",
    "здоровый образ жизни": "Красота, здоровье",
    "зимние виды спорта": "Спорт",
    "знакомства": "Общение и знакомства",
    "зоомагазин": "Животные",
    "зоопарк": "Животные",
    "игра": "Видеоигры",
    "игровая студия": "Видеоигры",
    "игры": "Видеоигры",
    "игры, игрушки": "Семья, дети",
    "издательский дом": "Журналистика",
    "инвестиции": "Бизнес и финансы",
    "инди": "Музыка",
    "институт": "Образование",
    "интеллектуальные игры": "Хобби и развлечения",
    "интернет": "IT и технологии",
    "интернет-магазин": "Торговля и магазины",
    "интернет-провайдер": "IT и технологии",
    "интернет-сми": "СМИ",
    "интерьер": "Дом и ремонт",
    "информационный портал": "Разное",
    "искусство и развлечения": "Хобби и развлечения",
    "история": "Культура, искусство",
    "кафе": "Еда и напитки",
    "кафе, ресторан": "Еда и напитки",
    "квест": "Хобби и развлечения",
    "киберспорт": "Спорт",
    "киберспортивная команда": "Спорт",
    "киберспортивная организация": "Спорт",
    "кинематограф": "Кино",
    "кино": "Кино",
    "кинотеатр": "Кино",
    "классическая музыка": "Музыка",
    "клиника": "Медицина и здоровье",
    "клуб": "Общение и знакомства",
    "книга": "Книги",
    "книжный магазин": "Книги",
    "колледж": "Образование",
    "комик": "Юмор",
    "компания": "Бизнес и предпринимательство",
    "композитор": "Музыка",
    "компьютерная техника": "IT и технологии",
    "компьютерные услуги": "IT и технологии",
    "консалтинг, бизнес-услуги": "Бизнес и финансы",
    "концерт": "Музыка",
    "концертный зал": "Музыка",
    "косметология": "Красота, здоровье",
    "кофейня": "Еда и напитки",
    "критик": "Журналистика",
    "кулинария": "Еда и напитки",
    "кулинария, рецепты": "Еда и напитки",
    "культура": "Культура, искусство",
    "культура и искусство": "Культура, искусство",
    "культурный центр": "Культура, искусство",
    "курсы": "Образование",
    "латиноамериканская музыка": "Музыка",
    "летние виды спорта": "Спорт",
    "летний лагерь": "Семья, дети",
    "литература": "Культура, искусство",
    "лёгкая атлетика": "Спорт",
    "магазин": "Торговля и магазины",
    "мебель": "Дом и ремонт",
    "медицина": "Медицина и здоровье",
    "медицинская услуга": "Медицина и здоровье",
    "медицинский центр": "Медицина и здоровье",
    "место отдыха": "Путешествия и отдых",
    "метал": "музыка",
    "мобильные технологии": "IT и технологии",
    "модель": "Мода и стиль",
    "модельное агентство": "Мода и стиль",
    "молодёжное движение": "Общество",
    "мототехника": "Авто и мото",
    "мотоциклы и другая мототехника": "Авто и мото",
    "музей, галерея, выставка": "Культура, искусство",
    "музыка": "Музыка",
    "музыкальная группа": "Музыка",
    "музыкальные инструменты": "Музыка",
    "музыкальный лейбл": "Музыка",
    "музыкант": "Музыка",
    "мультфильм": "Кино",
    "народная музыка, фолк": "Музыка",
    "настольные игры": "Хобби и развлечения",
    "наука": "Наука и космос",
    "недвижимость": "Недвижимость",
    "некоммерческая организация": "Общество",
    "нотариальная контора": "Услуги",
    "ночной клуб": "Хобби и развлечения",
    "обмен музыкой": "Музыка",
    "оборудование": "Разное",
    "образование": "Образование",
    "образовательное учреждение": "Образование",
    "обучающие курсы": "Образование",
    "общественная организация": "Общество",
    "общественное движение": "Общество",
    "общественный деятель": "Общество",
    "общество": "Общество",
    "объявления": "Разное",
    "одежда, обувь": "Мода и стиль",
    "онлайн-игра": "Видеоигры",
    "оператор мобильной связи": "IT и технологии",
    "организация": "Общество",
    "организация праздников": "Праздники и события",
    "отдых на природе": "Путешествия и отдых",
    "отношения полов": "Знакомства",
    "охота и рыбалка": "Путешествия и отдых",
    "парк отдыха": "Путешествия и отдых",
    "парк развлечений": "Хобби и развлечения",
    "парфюмерия, косметика": "Красота, здоровье",
    "пассажирские перевозки": "Услуги",
    "певец": "Музыка",
    "певец или певица": "Музыка",
    "певица": "Музыка",
    "персонаж": "Развлечения и медиа",
    "печатное издание": "СМИ и журналистика",
    "печать, полиграфия": "Услуги",
    "писатель": "Культура и искусство",
    "писатель или писательница": "Культура и искусство",
    "писательница": "Культура и искусство",
    "платёжная система": "Разное",
    "подготовка к свадьбе": "Праздники и события",
    "поиск работы": "Финансы и страхование",
    "покупки": "Торговля и магазины",
    "политик": "Политика и государство",
    "политик, госслужащий": "Политика и государство",
    "политика": "Политика и государство",
    "политическая партия": "Политика и государство",
    "почтовая служба": "Услуги",
    "пошив и ремонт одежды": "Услуги",
    "поэт": "Культура и искусство",
    "поэт или поэтесса": "Культура и искусство",
    "поэтесса": "Культура и искусство",
    "предприниматель": "Бизнес и финансы",
    "предприниматель или предпринимательница": "Бизнес и финансы",
    "предпринимательница": "Бизнес и финансы",
    "приложение": "IT и технологии",
    "программирование": "IT и технологии",
    "программное обеспечение": "IT и технологии",
    "продажа билетов, бронирование гостиниц": "Путешествия и отдых",
    "продукты питания, напитки": "Еда и напитки",
    "производство контента": "Услуги",
    "производство, промышленность": "Разное",
    "прокат": "Музыка",
    "профессиональное училище": "Образование",
    "профессиональные услуги": "Услуги",
    "психолог": "Психология и саморазвитие",
    "психология": "Психология и саморазвитие",
    "публицист": "Культура и искусство",
    "публичная страница": "СМИ",
    "радиостанция": "Музыка",
    "развлечения": "Хобби и развлечения",
    "режиссёр": "Кино",
    "режиссёр, продюсер": "Кино",
    "реклама": "Услуги",
    "религиозное учреждение": "Религия и духовность",
    "религия": "Религия и духовность",
    "ремонтная мастерская": "Дом и ремонт",
    "ресторан": "Еда и напитки",
    "родители и дети": "Семья, дети",
    "родственники": "Общество",
    "рок": "Музыка",
    "ролевые игры": "Хобби и развлечения",
    "ролики": "Хобби и развлечения",
    "рыбалка": "Путешествия и отдых",
    "садоводство": "Дом и ремонт",
    "сайт": "IT и технологии",
    "сайты": "IT и технологии",
    "салон красоты": "Красота, здоровье",
    "салоны сотовой связи": "Торговля и магазины",
    "санаторий, дом отдыха": "Путешествия и отдых",
    "свадебный салон": "Праздники и события",
    "сериал": "Кино",
    "сми": "СМИ и коммуникации",
    "соседи": "общество",
    "спа-салон": "Красота, здоровье",
    "спектакль": "Культура и искусство",
    "спорт и красота": "Спорт",
    "спортивная команда": "Спорт",
    "спортивная одежда и обувь": "Спорт",
    "спортивная организация": "Спорт",
    "спортивное питание": "Спорт",
    "спортивные товары": "Спорт",
    "спортивный клуб": "Спорт",
    "спортивный комплекс": "Спорт",
    "спортсмен": "Спорт",
    "спортсмен / спортсменка": "Спорт",
    "спортсменка": "Спорт",
    "стилист, имиджмейкер": "Мода и стиль",
    "стиль, мода": "Мода и стиль",
    "стиль, одежда, обувь": "Мода и стиль",
    "стоматология": "Медицина и здоровье",
    "страна": "Разное",
    "стример": "Разное",
    "строительные и ремонтные работы": "Дом и ремонт",
    "строительные материалы, инструменты": "Дом и ремонт",
    "строительство, ремонт": "Дом и ремонт",
    "студия": "Услуги",
    "студия звукозаписи": "Музыка",
    "супермаркет": "Торговля и магазины",
    "такси": "Авто и мото",
    "танцевальная музыка": "Музыка",
    "танцевальная школа": "Музыка",
    "танцор": "Музыка",
    "танцы": "Музыка",
    "тату-салон": "Услуги",
    "творческое объединение": "Общество",
    "творчество": "Культура, искусство",
    "театр": "Культура, искусство",
    "тексты, аккорды": "Разное",
    "телеканал": "СМИ",
    "теннис": "Спорт",
    "техника, электроника": "IT и технологии",
    "товар": "Торговля и магазины",
    "товары для дачи, огорода": "Дом и ремонт",
    "товары для детей": "Семья и дети",
    "товары для дома": "Дом и ремонт",
    "товары для животных": "Животные",
    "товары для офиса": "Торговля и магазины",
    "товары для праздников": "Праздники и события",
    "товары для творчества": "Торговля и магазины",
    "торгово-развлекательный центр": "Торговля и магазины",
    "торговый центр": "Торговля и магазины",
    "транспорт": "Авто, мото",
    "транспортные услуги": "Услуги",
    "тренинг, семинар": "Образование",
    "турагентство": "Путешествия и отдых",
    "туризм": "Путешествия и отдых",
    "туризм и отдых": "Путешествия и отдых",
    "туризм, путешествия": "Туризм и отдых",
    "туристическое агентство": "Разное",
    "туры, экскурсии": "Путешествия и отдых",
    "украшения, бижутерия": "Торговля и магазины",
    "университет": "Образование",
    "университетский спорт": "Образование",
    "управляющая компания": "Бизнес и финансы",
    "услуга": "Услуги",
    "услуги для автовладельцев": "Авто и мото",
    "услуги для владельцев животных": "Животные",
    "уход за собой": "Красота, здоровье",
    "учёный, преподаватель": "Образование",
    "фан-сообщество": "Общество",
    "фестиваль": "Праздники и события",
    "философия": "Разное",
    "фильм": "Кино",
    "финансовые рынки": "Бизнес и финансы",
    "финансы": "Финансы и страхование",
    "фитнес": "Красота, здоровье",
    "фитнес-центр": "Спорт",
    "фото- и видеосъемка": "Фотография и видео",
    "фото- и видеосъёмка": "Фотография и видео",
    "фотограф": "Фотография и видео",
    "фотография": "Фотография и видео",
    "футбол": "Спорт",
    "футболист": "Спорт",
    "футбольная команда": "Спорт",
    "химчистка, прачечная": "Дом и ремонт",
    "хоккей": "Спорт",
    "хоккейная команда": "Спорт",
    "хостел": "Путешествия и отдых",
    "хостинг, регистрация доменов": "IT и технологии",
    "храм": "Религия и духовность",
    "художник": "Культура и искусство",
    "художник или художница": "Культура и искусство",
    "художница": "Культура и искусство",
    "цветы": "Торговля и магазины",
    "цирк": "Хобби и развлечения",
    "часы": "Мода и стиль",
    "школа": "Образование",
    "шоу": "Развлечения и медиа",
    "шоу, передача": "Развлечения и медиа",
    "шоу-бизнес": "Бизнес и финансы",
    "экономика и финансы": "Бизнес и финансы",
    "экстремальный спорт": "Спорт",
    "электроника": "IT и технологии",
    "электронная музыка": "Музыка",
    "эротика": "Разное",
    "ювелирные изделия": "Торговля и магазины",
    "юмор": "Развлечения и медиа",
    "юридические услуги": "Услуги",
    "языки": "Разное",
    }

# --- конфигурация страницы ---
st.set_page_config(page_title="VK Анализ", layout="wide")
st.title("🧠 VK Анализ: Сбор и анализ профилей ВКонтакте")

# --- загрузка файла ---
uploaded = st.sidebar.file_uploader("Загрузите CSV с колонкой VK ID", type=["csv"])

st.sidebar.markdown("""
### ℹ️ О приложении
- 🔑 Введите VK API токен
- 📥 Загружаем ID пользователей
- 🤖 Сбор данных через API: `users.get`, `groups.get`
""")

if uploaded:
    df_ids = pd.read_csv(uploaded)
    if "VK ID" not in df_ids.columns:
        st.error("В файле нет колонки 'VK ID'")
        st.stop()

    ids = df_ids["VK ID"].astype(int).tolist()
    vk_token = st.sidebar.text_input("Введите VK API токен", type="password")

    if vk_token and st.sidebar.button("Собрать данные из VK API"):
        BASE_URL = 'https://api.vk.com/method/'
        API_VERSION = '5.199'
        results = []
        chunks = [ids[i:i+100] for i in range(0, len(ids), 100)]

        for idx, chunk in enumerate(chunks):
            st.write(f"🔄 Обрабатываем пользователей {idx*100+1}-{idx*100+len(chunk)}")
            try:
                resp = requests.get(BASE_URL + 'users.get', params={
                    'user_ids': ','.join(map(str, chunk)),
                    'fields': 'activities,bdate,city,country,education,last_seen,occupation,sex,universities',
                    'access_token': vk_token,
                    'v': API_VERSION
                }).json()
                
                # 🔍 покажем весь ответ от VK API
                st.write("📦 Ответ от VK API (users.get):", resp)
                
                for user in resp.get("response", []):
                    st.write(user)  # 🔍 покажем отдельного пользователя
                    row = {
                        "VK ID": user.get("id"),
                        "first_name": user.get("first_name"),
                        "last_name": user.get("last_name"),
                        "activities": user.get("activities"),
                        "bdate": user.get("bdate"),
                        "city": user.get("city", {}).get("title") if isinstance(user.get("city"), dict) else None,
                        "country": user.get("country", {}).get("title") if isinstance(user.get("country"), dict) else None,
                        "university_name": user.get("education", {}).get("university_name") if isinstance(user.get("education"), dict) else None,
                        "faculty_name": user.get("education", {}).get("faculty_name") if isinstance(user.get("education"), dict) else None,
                        "last_seen_time": user.get("last_seen", {}).get("time") if isinstance(user.get("last_seen"), dict) else None,
                        "occupation_type": user.get("occupation", {}).get("type") if isinstance(user.get("occupation"), dict) else None,
                        "sex": user.get("sex"),
                        "faculty_from_universities": user.get("universities", [{}])[0].get("faculty_name") if isinstance(user.get("universities"), list) else None,
                    }

                    group_resp = requests.get(BASE_URL + 'groups.get', params={
                        'user_id': user.get("id"),
                        'access_token': vk_token,
                        'v': API_VERSION,
                        'extended': 1,
                        'fields': 'activity',
                        'count': 1000
                    }).json()

                    if "response" in group_resp:
                        groups = group_resp["response"]["items"]
                        row["group_count"] = len(groups)
                        for j, group in enumerate(groups[:50], start=1):
                            row[f"group_{j}_name"] = group.get("name", "")
                            row[f"group_{j}_activity"] = group.get("activity", "")
                    elif "error" in group_resp:
                        st.warning(f"VK API ошибка: {group_resp['error']}")

                    results.append(row)
                    time.sleep(0.5)
            except Exception as e:
                st.error(f"Ошибка при запросе users.get: {e}")
                continue

        df = pd.DataFrame(results)
        st.session_state["df"] = df
        st.success("✅ Данные собраны!")

# --- простой вывод результата ---
if "df" in st.session_state:
    df = st.session_state["df"]
    st.subheader("📋 Полученные данные:")
    st.dataframe(df, use_container_width=True)
    st.write("📌 Колонки в таблице:")
    st.write(df.columns.tolist())

    if "last_seen_time" not in df.columns:
        st.warning("⚠️ Колонка 'last_seen_time' отсутствует. Поле не пришло от VK API.")

else:
    st.info("Загрузите CSV с VK ID")
